# Portable Executables
* the binary file format that Microsoft Windows uses for executables (EXE), dynamic link libraries (DLL) and others.
* derived from COFF (Common Object File Format) used by most Unix executables.
* 
## Portable Executable File Format
* Overview \
![image](https://user-images.githubusercontent.com/88809233/167351089-681613fe-7733-451d-a606-d3638270fecc.png)
* Detailed \
![image2](https://raw.githubusercontent.com/corkami/pics/master/binary/PE101.png)
* Extensions that use the PE Format

|Extensions|Description| |Extensions|Description|
|----------|-----------|-|----------|-----------|
|.exe|Executable| |.efi|Extensible Firmware Interface file (bootloader executables)|
|.dll|Dynamic-link Library| |.mui|Multilingual User Interface file - contains resources that allow changing the Windows Interface to display different languages|
|.acm|Audio Compression Manager| |.ocx|ActiveX Form|
|.ax|MPEG-4 DVD Filter| |.scr|Screensaver|
|.cpl|Control Panel| |.sys|Device Driver (Kernel)|
|.drv|Driver file(Kernel)| |.tsp|Windows Telephony Service Provider File|

## Shared Libraries
* Executables nowadays depend on other executables or libraries.
* A library is a collection of code that can be used by multiple programs at the same time.
* In Microsoft Executables, the library will use the `.dll` file extension but will have headers that are similar to `.exe` files.

## Static vs Dynamic Linking
* Linker is responsible for adding the libraries into the final executable.
* There are 2 types of linkers : 
   1. With static linking, the linker will resolve all library requirements and copy the library into the final executable, thus producing an executable with the library embedded inside.
   2. Dynamic Linking is sub divided into two more types : 
      * Implicit Linking
         * Linker links the referenced library into the program but the functions referenced do not get added to the executable and are only loaded at execution time.
         * At execution time, OS loads the library for the executable and manages all the memory addresses for the program. 
         * Implicitly linked executables will have a section in the PE structure (.rdata), which holds all the libraries being imported and the functions referenced.
      
      * Explicit Linking
         * Explicit linking does not require an import section nor the linker to link the library to the program.
         * It is done at the source code side and the OS does not need to load the library on runtime.
         * Example is `LoadLibrary()` function and `GetProcAddress()`
### Performance Comparison
|Comparison|Static|Dynamic|
|----------|------|-------|
|Referencing|Faster|Slower|
|Executable Size|Bigger|Smaller|
|maintenance|more difficult|easier|
|Memory Usage|Higher|Lower|

# PE File Header Analysis
* Main Headers for Analysis : 
   1. MS-DOS Header
      * This is the start of the PE file and there are 2 things to look out for : 
         1. Signature : *magic byte* in ASCII `MZ` or HEX `0x5A4D`
         2. e_lfanew : DWORD offset to PE header in ASCII `PE\0\0`

   2. IMAGE_FILE_HEADERS (encapsulated in IMAGE_NT_HEADERS) 
      * This is the COFF file header
         1. Machine : Identifies the target machine this program is used on - i386(x86) vs amd64(x64)
         2. Number of Sections : Shows the number of sections this program has
         3. Time Date Stamp : Indicates the time file was created (prone to time stomping)
         4. Characteristics : Indicates the attributes of the files
            * Example of what can be found in Characteristics
      ![image](https://user-images.githubusercontent.com/88809233/167371543-e210c938-60a5-4000-a507-0348acd6f788.png)


   3. Optional Header
      * contains all the information the loader requires in order to load the program 
      ![image](https://user-images.githubusercontent.com/88809233/167371169-9a95c5b9-f178-4e01-a680-f1af7c45e262.png)
      ![image](https://user-images.githubusercontent.com/88809233/167371204-589ef739-a87a-4a0f-87ad-7edf9e0ee713.png)
      * Reference for the mapping of MajorOperatingSystemVersion field with the corresponding [Windows OS](https://en.wikipedia.org/wiki/Comparison_of_Microsoft_Windows_versions)

* Addresses



